<!DOCTYPE html>
<html>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js" integrity="sha512-UXumZrZNiOwnTcZSHLOfcTs0aos2MzBWHXOHOuB0J/R44QB0dwY5JgfbvljXcklVf65Gc4El6RjZ+lnwd2az2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
	
	<body>
		
		<button onclick="zoomHandlerReset()">Zoom Reset</button>
		<button onclick="zoomHandlerOut()">Zoom Out</button>

		<div>
			<canvas id="unrealChart"></canvas>
		</div>
		
		<script>		
			// Hide loader from screen.
			function hideloader() 
			{
				document.getElementById('loading').style.display = 'none';
			}

			// We need to construction zoom options before chart options. Because we use this in it.
			const zoomOptions = 
			{
  				pan: 
				{
    				enabled: true,
    				modifierKey: 'ctrl'
  				},
  				
				zoom: 
				{
    				drag: 
					{
      					enabled: true
    				},
    			
					mode: 'xy'
				}
			};

			const panStatus = () => zoomOptions.pan.enabled ? 'enabled' : 'disabled';
			const zoomStatus = () => zoomOptions.zoom.drag.enabled ? 'enabled' : 'disabled';
		
			const ChartConfig = 
			{
				// "bar", "line", "pie", "doughnut", "polarArea", "radar"
				type: 'bar',
				data: 
				{
					labels: [],
					datasets: [
					{
						yAxisID: "y1",
						label: 'Values',
						data: [],
						borderWidth: 3,
						//backgroundColor: "#9ad0f5",
						hoverBackgroundColor: "red"
					}
				]
				},

				options: 
				{
					// https://www.chartjs.org/docs/latest/configuration/device-pixel-ratio.html
					devicePixelRatio: window.devicePixelRatio,
					responsive: true,
		
					plugins: 
					{
						zoom: zoomOptions,
      						title:
							{
        						display: true,
        						position: 'bottom',
        						text: (ctx) => 'Zoom: ' + zoomStatus() + ', Pan: ' + panStatus()
							}
					},

					scales: 
					{

						y1: 
						{
							display: true,
							beginAtZero: true,
							position: "left",
							
							title: 
							{
								display: true,
								text: "Y1 Axis",
								color: "#9ad0f5",
								
								font:
								{
									size: 24,
									weight: "bold"
								}	
							}
						}
					}
				}
			}

			// Construct chart based on configurations.
			const ctx = document.getElementById('unrealChart');
			const BasicChart = new Chart(ctx, ChartConfig);

			// Zoom reset handler for button.
			function zoomHandlerReset()
			{
				var zoomButtonReset = document.createComment('button');
				zoomButtonReset.innerText = "Zoom Reset";

				var body = document.getElementsByTagName("body")[0];
				body.appendChild(zoomButtonReset);

				zoomEventReset();
			}

			// We exposed it as function because we can trigger it from Unreal, too.
			function zoomEventReset()
			{
				BasicChart.resetZoom();
			}

			// Zoom out handler for button.
			function zoomHandlerOut()
			{
				var zoomButtonOut = document.createComment('button');
				zoomButtonOut.innerText = "Zoom Out";

				var body = document.getElementsByTagName("body")[0];
				body.appendChild(zoomButtonOut);

				zoomEventOut(0.1);
			}

			// We exposed it as function because we can trigger it from Unreal, too.
			function zoomEventOut(outValue)
			{
				BasicChart.zoom(outValue);
			}

			// Click events.
			function clickHandler(click)
			{
				const points = BasicChart.getElementsAtEventForMode(click, 'nearest', { intersect: true }, true);
				
				if(Object.keys(points).length)
				{
					const firstPoint = points[0];

					const indexDataset = firstPoint.datasetIndex;
					const indexData = firstPoint.index;
					
					const dataLabel = BasicChart.data.labels[indexData];
					const dataValue = BasicChart.data.datasets[indexDataset].data[indexData];
					const datasetLabel = BasicChart.data.datasets[indexDataset].label;
					
					const clickString = "click&&" + dataLabel + "_" + dataValue + "&&" + indexDataset + "_" + indexData + "&&" + datasetLabel;
					
					console.log(clickString);

					// We will add additional API fetch functions to here.
				}
			}
			ctx.onclick = clickHandler;

			let lastHovered;
			function mouseMoveHandler(chart, mousemove)
			{
				const points = BasicChart.getElementsAtEventForMode(mousemove, 'nearest', { intersect: true }, true);
				
				if(Object.keys(points).length)
				{
					const firstPoint = points[0];

					const indexDataset = firstPoint.datasetIndex;
					const indexData = firstPoint.index;
					
					const dataLabel = BasicChart.data.labels[indexData];
					const dataValue = BasicChart.data.datasets[indexDataset].data[indexData];
					const datasetLabel = BasicChart.data.datasets[indexDataset].label;
					
					const clickString = "hover&&" + dataLabel + "_" + dataValue + "&&" + indexDataset + "_" + indexData + "&&" + datasetLabel;

					if(lastHovered !== clickString)
					{
						lastHovered = clickString;
						console.log(clickString);

						// We will add additional API fetch functions to here.
					}
				}
			}

			BasicChart.canvas.addEventListener("mousemove", (e) =>
			{
				mouseMoveHandler(BasicChart, e);
			});

			// Change chart size based on browser size.
			window.onresize = function()
			{
				BasicChart.resize();
				BasicChart.update();
				BasicChart.render();
			}

			//Add new dataset to the chart. For example, multiple bar or lines. Supported types are "bar", "line", "pie", "doughnut", "polarArea", "radar".
			function dataset_add(newColor, newAxisId, newLabel, newBorderWidth, newType)
			{
				BasicChart.data.datasets.push(
					{
						backgroundColor: newColor,
						yAxisID: newAxisId,
						label : newLabel,
						borderWidth : newBorderWidth,
						type: newType
					}
				);

				BasicChart.update();
				BasicChart.render();
			}
			//dataset_add("red", "y2", "Unreal Dataset", 3, "bar");

			function dataset_remove(indexDataset, axisId)
			{
				BasicChart.data.datasets.splice(indexDataset, 1);
				delete BasicChart.options.scales[axisId];

				BasicChart.update();
				BasicChart.render();
			}
			//dataset_remove(1, "y2");

			// Change properties of target dataset. Supported types are "bar", "line", "pie", "doughnut", "polarArea", "radar".
			function dataset_change(indexDataset, newColor, newHoveredColor, newAxisId, newLabel, newBorderWidth, newType)
			{
				const targetDataSet = BasicChart.data.datasets[indexDataset];
				if(targetDataSet == null)
				{
					console.log("Target dataset is null.")
					return;
				}

				targetDataSet.backgroundColor = newColor;
				targetDataSet.hoverBackgroundColor  = newHoveredColor;
				targetDataSet.yAxisID = newAxisId;
				targetDataSet.label = newLabel;
				targetDataSet.borderWidth = newBorderWidth;
				targetDataSet.type = newType;
				
				BasicChart.update();
				BasicChart.render();
			}
			//dataset_change(0, "blue", "red", "y1", "Unreal Dataset New Name", 3, "bar");

			function data_add(indexDataset, newName, newValue, deleteBefore)
			{
				const targetDataSet = BasicChart.data.datasets[indexDataset];
				if(targetDataSet == null)
				{
					console.log("Target dataset is null.")
					return;
				}

				if(newName !== null)
				{
					if(deleteBefore)
					{
						BasicChart.data.labels.splice(0, Object.keys(newName).length);
					}

					newName.forEach(element => 
					{
						BasicChart.data.labels.push(element);
					});
				}

				if(newValue !== null)
				{
					if(deleteBefore)
					{
						targetDataSet.data.splice(0, Object.keys(newValue).length);
					}

					if(newName !== null || BasicChart.data.labels.lenght > 0)
					{
						newValue.forEach(element =>
						{
							targetDataSet.data.push(element);
						});
					}
					
					else
					{
						console.log("There is no label for value.")
					}
				}
				
				BasicChart.update();
				BasicChart.render();
			}
			data_add(0, ['data1', 'data2', 'data3'], [10, 5, 9], false);
			data_add(0, ['c++', 'flutter', 'after_effects'], [0.1, 0.5, 0.9], false);

			// Add new data to the target dataset.
			function data_remove(indexDataset, indexValue, count, bDeleteLabel, bSetZero)
			{
				const targetDataSet = BasicChart.data.datasets[indexDataset];
				if(targetDataSet == null)
				{
					console.log("Target dataset is null.")
					return;
				}

				if(bSetZero)
				{
					targetDataSet.data[indexValue] = 0;
				}

				else
				{
					targetDataSet.data.splice(indexValue, count);
				}

				if(bDeleteLabel && !bSetZero)
				{
					BasicChart.data.labels.splice(indexValue, count);
				}

				BasicChart.update();
				BasicChart.render();
			}
			//data_remove(0, 1, 1, true, false); // This will delete second entry completely. "bSetZero" have to be false. 
			//data_remove(0, 1, 1, false, true); // This will make second entry to 0. "bDeleteLabel" can be true or false. It won't matter.

			function data_update_label(indexDataset, indexLabel, newLabel)
			{
				if(BasicChart.data.labels[indexLabel] == null)
				{
					console.log("Target label is null.")
					return;
				}

				BasicChart.data.labels[indexLabel] = newLabel;

				BasicChart.update();
				BasicChart.render();
			}
			//data_update_label(0, 0, "Unreal");

			function data_update_value(indexDataset, indexValue, newValue)
			{
				if(BasicChart.data.datasets[indexDataset] == null)
				{
					console.log("Target dataset is null.")
					return;
				}

				if(BasicChart.data.datasets[indexDataset].data[indexValue] == null)
				{
					console.log("Target data is null.")
					return;
				}

				BasicChart.data.datasets[indexDataset].data[indexValue] = newValue;

				BasicChart.update();
				BasicChart.render();
			}
			//data_update_value(0, 0, 100);

			function axis_set_style(axisId, newDisplay, newBeginAtZero, newAxisTitle, newColor, newPosition, newFontSize, newFontWeight)
			{
				const targetAxis = BasicChart.options.scales[axisId];
				if (targetAxis == null)
				{
					console.log("Target axis is null.");
					return;
				}

				targetAxis.display = newDisplay;
				targetAxis.beginAtZero = newBeginAtZero;
				targetAxis.position = newPosition;
				
				targetAxis.title.display = true;
				targetAxis.title.text = newAxisTitle;
				targetAxis.title.color = newColor;

				targetAxis.title.font = 
				{
					size: newFontSize,
					weight: newFontWeight
				}

				BasicChart.update();
				BasicChart.render();
			}
			//axis_set_style("y2", true, true, "New Axis", "red", "left", 24, "bold");

			function axis_add_grid(axisId, threshold, smallerColor, biggerColor, equalColor)
			{
				const targetAxis = BasicChart.options.scales[axisId];
				if(targetAxis == null)
				{
					console.log("Target axis is null.");
					return;
				}
				
				targetAxis.grid =
				{
					color: function(context) 
								{
            						if (context.tick.value < threshold)
									{
              							return smallerColor;
            						}
									
									else if (context.tick.value > threshold) 
									{
              							return biggerColor;
            						}
						
									return equalColor;
								}
				}

				BasicChart.update();
				BasicChart.render();
			}
			//axis_add_grid('y1', 10, "red", "green", "black");

		</script>
		
	</body>
</html>